<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Painel de Produção - BF BOX</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { margin:0; font-family: Arial,sans-serif; background:#f2f2f2; }
header { display:flex; align-items:center; justify-content:space-between; background:#fff; padding:10px 20px; box-shadow:0 2px 5px rgba(0,0,0,0.1); position:sticky; top:0; z-index:100;}
header img { height:50px; }
header .logo { display:flex; align-items:center; gap:20px; }
header .tabs { display:flex; gap:10px; margin-left:20px; }
header .tab { cursor:pointer; padding:5px 15px; border-radius:5px; background:#e0e0e0; }
header .tab.active { background:#4CAF50; color:white; }
#filtro { margin:10px auto; text-align:center; }
#filtro select { padding:5px 10px; font-size:1em; border-radius:5px; }
#machines, #cargasContainer { display:flex; flex-direction:column; gap:10px; padding:10px; }
.machine { background:white; padding:10px; border-radius:10px; display:flex; flex-direction:column; }
.machine h2 { margin:0 0 10px 0; }
.machine table { width:100%; border-collapse:collapse; }
.machine th, .machine td { border-bottom:1px solid #ddd; padding:5px; text-align:right; }
.carga-card { background:white; border-radius:10px; padding:10px; margin:5px; display:flex; flex-direction:column; gap:5px; position:relative; }
.carga-card h2 { display:flex; justify-content:space-between; align-items:center; margin:0; }
.carga-menu { cursor:pointer; font-size:1.5em; margin-left:5px; }
.carga-itens { display:flex; flex-direction:column; gap:3px; margin-top:5px; }
.carga-item { display:flex; justify-content:space-between; align-items:center; background:#f9f9f9; padding:5px 10px; border-radius:5px; }
.carga-item .delete-item { margin-left:10px; cursor:pointer; }
.add-item { align-self:center; padding:5px 10px; border-radius:50%; font-size:1.2em; cursor:pointer; }
#upload-section { text-align:center; margin:20px; }
#upload-section input, #upload-section button { margin:5px; padding:5px 10px; }
.prioridade { background:yellow; font-weight:bold; }
/* MOBILE */
@media(max-width:480px){
  .machine table th, .machine table td { font-size:0.8em; padding:3px; text-align:left; }
  .carga-card { width:100%; }
  .carga-item { flex-direction:column; align-items:flex-start; }
  .carga-item select { width:50%; margin-top:3px; }
}
</style>
</head>
<body>

<header>
  <div class="logo">
    <img src="https://site.siteargus.com.br/sendThumb.asp?idcliente=543&path=parceiro&file=27_6_543_458_13510820_510120865837737_6061197160572500699_n.jpg&width=280" alt="BF BOX">
    <div class="tabs">
      <div class="tab active" id="tabProducao">Produção</div>
      <div class="tab" id="tabCargas">Cargas</div>
    </div>
  </div>
  <div id="hora"></div>
</header>

<div id="filtro">
  <label>Filtrar Máquina: </label>
  <select id="filterMachines">
    <option value="">Todas</option>
  </select>
</div>

<div id="machines"></div>
<div id="cargasContainer" style="display:none;"></div>

<div id="upload-section">
  <input type="file" id="fileInput">
  <button onclick="upload()">Carregar XLS</button>
  <button onclick="exportAlteracoes()">Exportar Alterações</button>
</div>

<script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
let currentData = [];
let alteracoes = new Set();
let cargasData = [];

// Atualiza hora
function updateHora(){ document.getElementById('hora').textContent = new Date().toLocaleString(); }
setInterval(updateHora,1000); updateHora();

// Abas
const tabProducao=document.getElementById('tabProducao');
const tabCargas=document.getElementById('tabCargas');
const filtro=document.getElementById('filtro');
tabProducao.onclick=()=>{ tabProducao.classList.add('active'); tabCargas.classList.remove('active'); document.getElementById('machines').style.display='flex'; document.getElementById('cargasContainer').style.display='none'; filtro.style.display='block'; }
tabCargas.onclick=()=>{ tabCargas.classList.add('active'); tabProducao.classList.remove('active'); document.getElementById('machines').style.display='none'; document.getElementById('cargasContainer').style.display='flex'; filtro.style.display='none'; }

// FILTRO
const filterSelect=document.getElementById('filterMachines');
filterSelect.onchange=()=>renderMachines(currentData);

// UPLOAD XLS
function upload(){
  const file=document.getElementById('fileInput').files[0];
  if(!file){ alert('Selecione um arquivo'); return; }
  const reader=new FileReader();
  reader.onload=(evt)=>{
    const data=new Uint8Array(evt.target.result);
    const workbook=XLSX.read(data,{type:'array'});
    const sheet=workbook.Sheets[workbook.SheetNames[0]];
    const rows=XLSX.utils.sheet_to_json(sheet,{header:1});
    currentData=[];
    const maquinasSet=new Set();
    for(let i=5;i<rows.length;i++){
      const row=rows[i];
      if(!row || !row[0]) continue;
      const item={
        item: row[0],
        maquina: row[7] || 'Sem Máquina',
        vendido: row[10]||0,
        estoque: row[12]||0,
        produzir: row[16]||0,
        status: ''
      };
      if(row[6]==='PRIORIDADE') item.prioridade=true;
      currentData.push(item);
      maquinasSet.add(item.maquina);
    }
    filterSelect.innerHTML='<option value="">Todas</option>';
    maquinasSet.forEach(m=>{ filterSelect.innerHTML+=`<option value="${m}">${m}</option>`; });
    renderMachines(currentData);
    socket.emit('updateProducoes',currentData);
  };
  reader.readAsArrayBuffer(file);
}

// RENDER PRODUÇÃO
function renderMachines(data){
  const container=document.getElementById('machines');
  container.innerHTML='';
  const filterVal=filterSelect.value;
  const grouped={};
  data.forEach((item,i)=>{
    if(filterVal && item.maquina!==filterVal) return;
    if(!grouped[item.maquina]) grouped[item.maquina]=[];
    grouped[item.maquina].push({...item,index:i});
  });
  Object.keys(grouped).forEach(maquina=>{
    const div=document.createElement('div');
    div.className='machine';
    div.innerHTML=`<h2>${maquina}</h2>`;
    const table=document.createElement('table');
    table.innerHTML=`<tr><th>Item</th><th>V</th><th>E</th><th>P</th><th>Status</th></tr>`;
    grouped[maquina].forEach(it=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td class="${it.prioridade?'prioridade':''}">${it.item}</td>
        <td>${it.vendido}</td>
        <td>${it.estoque}</td>
        <td>${it.produzir}</td>
      `;
      const td=document.createElement('td');
      const sel=document.createElement('select');
      sel.innerHTML=`<option value="">Selecione</option><option value="producao">Produção</option><option value="producao-finalizada">Produção Finalizada</option><option value="acabamento">Acabamento</option><option value="acabamento-finalizado">Acabamento Finalizado</option>`;
      sel.onchange=()=>{ it.status=sel.value; alteracoes.add(it.index); tr.style.backgroundColor=sel.value?'#d0ffd0':'white'; socket.emit('statusUpdate',{index:it.index,status:sel.value}); };
      td.appendChild(sel);
      tr.appendChild(td);
      table.appendChild(tr);
    });
    div.appendChild(table);
    container.appendChild(div);
  });
}

// SOCKETS
socket.on('updateProducoes',data=>{ currentData=data; renderMachines(currentData); });
socket.on('updateCargas',data=>{ cargasData=data; renderCargas(cargasData); });

// EXPORTAR ALTERAÇÕES
function exportAlteracoes(){
  const exportData=currentData.filter((_,i)=>alteracoes.has(i)).map(it=>({
    item: it.item,
    maquina: it.maquina,
    vendido: it.vendido,
    estoque: it.estoque,
    produzir: it.produzir,
    status: it.status
  }));
  const ws=XLSX.utils.json_to_sheet(exportData);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'Alteracoes');
  XLSX.writeFile(wb,'alteracoes.xlsx');
}
</script>

</body>
</html>
