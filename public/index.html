<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Painel BF Box - Produção & Cargas</title>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
<style>
body { font-family:sans-serif; margin:0; padding:0; background:#f5f5f5; }
header { display:flex; justify-content:space-between; align-items:center; padding:10px; background:#fff; box-shadow:0 2px 5px rgba(0,0,0,0.1); flex-wrap:wrap; }
header img { height:50px; }
.header-center { display:flex; flex-direction:column; align-items:center; flex:1; }
.tabs { display:flex; margin-top:5px; }
.tab { margin:0 5px; padding:5px 10px; cursor:pointer; border-radius:5px; background:#ddd; font-size:0.9em; }
.tab.active { background:#bbb; font-weight:bold; }
#hora { font-weight:bold; }
#filtro-maquinas { text-align:center; margin:10px; }
#filtro-maquinas select { padding:5px 10px; font-size:1em; }
section { padding:10px; }
.machine-card, .carga-card { background:#fff; margin-bottom:10px; padding:10px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1); display:flex; flex-direction:column; }
.machine-card h2, .carga-card h2 { margin:0 0 10px 0; }
.item-row { display:flex; justify-content:space-between; padding:5px 0; border-bottom:1px solid #eee; align-items:center; }
.item-row.prioridade { background:#fff59d; }
.item-info { flex:2; }
.quantidades { text-align:right; flex:1; font-size:0.9em; color:#555; }
.status-select { flex:1; }
#upload-section { text-align:center; margin-top:20px; }
button.add-item { margin-top:5px; padding:3px 6px; font-size:0.9em; }

@media(max-width:600px){
  .item-row { flex-direction:column; align-items:flex-start; }
  .quantidades { text-align:left; width:100%; order:1; }
  .status-select { width:50%; margin-top:5px; order:2; }
  .item-info { order:0; width:100%; margin-bottom:3px; }
  #filtro-maquinas { margin:5px 0; }
  .tabs { justify-content:center; width:100%; margin-top:5px; }
}
</style>
</head>
<body>

<header>
  <img src="https://site.siteargus.com.br/sendThumb.asp?idcliente=543&path=parceiro&file=27_6_543_458_13510820_510120865837737_6061197160572500699_n.jpg&width=280" alt="Logo BF Box">
  <div class="header-center">
    <div class="tabs">
      <div class="tab active" data-tab="producao">Produção</div>
      <div class="tab" data-tab="cargas">Cargas</div>
    </div>
    <div id="filtro-maquinas">
      <label>Filtrar por máquina: </label>
      <select id="selectMaquina">
        <option value="">Todas</option>
      </select>
    </div>
  </div>
  <div id="hora"></div>
</header>

<section id="producao-tab">
  <div id="machines"></div>
</section>

<section id="cargas-tab" style="display:none;">
  <div id="cargas-container"></div>
  <button onclick="addCarga()" style="margin-top:10px;">Adicionar nova carga</button>
</section>

<div id="upload-section">
  <input type="file" id="file">
  <button onclick="upload()">Carregar XLS</button>
</div>

<script>
const socket = io();
const machinesDiv = document.getElementById('machines');
const selectMaquina = document.getElementById('selectMaquina');
const cargasContainer = document.getElementById('cargas-container');
let currentData = [];
let cargaCount = 1;

// ===== PRODUÇÃO =====
function renderMachines(data){
  machinesDiv.innerHTML = '';
  const grouped = {};
  data.forEach((item, i)=>{
    const maquina = item.maquina || 'Sem Máquina';
    if(!grouped[maquina]) grouped[maquina] = [];
    grouped[maquina].push({...item, index:i});
  });

  // filtro de máquinas
  selectMaquina.innerHTML = '<option value="">Todas</option>';
  Object.keys(grouped).forEach(m=>{
    selectMaquina.innerHTML += `<option value="${m}">${m}</option>`;
  });

  const filter = selectMaquina.value;
  for(const m in grouped){
    if(filter && m!==filter) continue;
    const card = document.createElement('div');
    card.className = 'machine-card';
    const title = document.createElement('h2');
    title.textContent = m;
    card.appendChild(title);

    grouped[m].forEach(item=>{
      const row = document.createElement('div');
      row.className = 'item-row';
      if(item.prioridade) row.classList.add('prioridade');

      const info = document.createElement('div');
      info.className = 'item-info';
      info.textContent = item.item;
      row.appendChild(info);

      const quant = document.createElement('div');
      quant.className = 'quantidades';
      quant.textContent = `V:${item.vendido} E:${item.estoque} P:${item.produzir}`;
      row.appendChild(quant);

      const select = document.createElement('select');
      select.className = 'status-select';
      ['','Produção','Produção Finalizada','Acabamento','Acabamento Finalizado'].forEach(s=>{
        const opt = document.createElement('option');
        opt.value = s;
        opt.textContent = s;
        if(s===item.status) opt.selected = true;
        select.appendChild(opt);
      });
      select.addEventListener('change', ()=>updateStatus(item.index, select.value));
      row.appendChild(select);

      card.appendChild(row);
    });

    machinesDiv.appendChild(card);
  }
}

function updateStatus(index, status){
  fetch('/update',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({index,status})
  });
}

// ===== UPLOAD XLS =====
async function upload(){
  const file = document.getElementById('file').files[0];
  if(!file){ alert('Selecione um arquivo'); return; }
  const form = new FormData();
  form.append('file', file);

  const res = await fetch('/upload',{method:'POST',body:form});
  const json = await res.json();
  if(json.ok) alert(`Arquivo carregado: ${json.total} itens`);
  else alert('Erro no upload');
}

// ===== SOCKET.IO =====
socket.on('update', data=>{
  currentData = data;
  renderMachines(currentData);
  renderCargas(cargasData); // atualiza itens de carga para todos
});

// ===== HORA =====
function updateHora(){
  const h = new Date();
  document.getElementById('hora').textContent = h.toLocaleString();
}
setInterval(updateHora,1000);
updateHora();

// ===== ABAS =====
document.querySelectorAll('.tab').forEach(tab=>{
  tab.addEventListener('click', ()=>{
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById('producao-tab').style.display = tab.dataset.tab==='producao'?'block':'none';
    document.getElementById('cargas-tab').style.display = tab.dataset.tab==='cargas'?'block':'none';
  });
});

// ===== CARGAS =====
let cargasData = [];

function createCargaCard(title){
  const cardId = `carga-${cargaCount}`;
  const card = document.createElement('div');
  card.className = 'carga-card';
  card.id = cardId;
  const h = document.createElement('h2');
  h.textContent = title;
  card.appendChild(h);

  const selectStatus = document.createElement('select');
  ['Pendente','Carregando','Pronto'].forEach(s=>{
    const opt = document.createElement('option');
    opt.value = s;
    opt.textContent = s;
    selectStatus.appendChild(opt);
  });
  selectStatus.addEventListener('change', ()=>{
    const c = cargasData.find(c=>c.id===cardId);
    if(c) c.status = selectStatus.value;
    socket.emit('cargaUpdate', cargasData);
  });
  card.appendChild(selectStatus);

  const itemsDiv = document.createElement('div');
  itemsDiv.className = 'items-div';
  card.appendChild(itemsDiv);

  const addBtn = document.createElement('button');
  addBtn.className = 'add-item';
  addBtn.textContent = 'Adicionar item';
  addBtn.addEventListener('click', ()=>{
    const nome = prompt('Nome do item:');
    if(!nome) return;
    const itemId = `item-${Date.now()}`;
    const row = document.createElement('div');
    row.className = 'item-row';
    row.id = itemId;

    const info = document.createElement('div');
    info.className = 'item-info';
    info.textContent = nome;
    row.appendChild(info);

    const selectItemStatus = document.createElement('select');
    ['Aguardando','Faturado'].forEach(s=>{
      const opt = document.createElement('option');
      opt.value = s;
      opt.textContent = s;
      selectItemStatus.appendChild(opt);
    });
    selectItemStatus.addEventListener('change', ()=>{
      const item = cargasData.find(c=>c.id===cardId).items.find(i=>i.id===itemId);
      if(item) item.status = selectItemStatus.value;
      socket.emit('cargaUpdate', cargasData);
    });
    row.appendChild(selectItemStatus);

    itemsDiv.appendChild(row);

    // salvar no array e atualizar todos
    const c = cargasData.find(c=>c.id===cardId);
    if(c){
      c.items.push({id:itemId, nome, status:selectItemStatus.value});
    }
    socket.emit('cargaUpdate', cargasData);
  });
  card.appendChild(addBtn);

  cargasContainer.appendChild(card);

  // adiciona ao array
  cargasData.push({id:cardId, title, status:selectStatus.value, items:[]});
  cargaCount++;
}

// CARGA 01 fixa
createCargaCard('CARGA 01');

// Adicionar nova carga
function addCarga(){
  const title = `CARGA ${String(cargaCount).padStart(2,'0')}`;
  createCargaCard(title);
}

// Recebe atualizações de cargas em tempo real
socket.on('cargaUpdate', data=>{
  cargasData = data;
  renderCargas(data);
});

function renderCargas(data){
  data.forEach(c=>{
    const card = document.getElementById(c.id);
    if(!card) return;
    card.querySelector('select').value = c.status;
    const itemsDiv = card.querySelector('.items-div');
    itemsDiv.innerHTML = '';
    c.items.forEach(i=>{
      const row = document.createElement('div');
      row.className = 'item-row';
      row.id = i.id;

      const info = document.createElement('div');
      info.className = 'item-info';
      info.textContent = i.nome;
      row.appendChild(info);

      const selectItemStatus = document.createElement('select');
      ['Aguardando','Faturado'].forEach(s=>{
        const opt = document.createElement('option');
        opt.value = s;
        opt.textContent = s;
        if(s===i.status) opt.selected=true;
        selectItemStatus.appendChild(opt);
      });
      selectItemStatus.addEventListener('change', ()=>{
        const item = cargasData.find(cd=>cd.id===c.id).items.find(it=>it.id===i.id);
        if(item) item.status = selectItemStatus.value;
        socket.emit('cargaUpdate', cargasData);
      });
      row.appendChild(selectItemStatus);

      itemsDiv.appendChild(row);
    });
  });
}

</script>

</body>
</html>
