<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Painel de Produção BF Box</title>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
<style>
body { font-family: sans-serif; margin:0; padding:0; background:#f5f5f5; }
header { display:flex; justify-content:space-between; align-items:center; padding:10px; background:#fff; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
header img { height:50px; }
header .hora { font-weight:bold; }
section { padding:10px; }
.machine-card { background:#fff; margin-bottom:10px; padding:10px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1); display:flex; flex-direction:column; }
.machine-card h2 { margin:0 0 10px 0; }
.item-row { display:flex; justify-content:space-between; padding:5px 0; border-bottom:1px solid #eee; align-items:center; }
.item-row.prioridade { background:#ffe0e0; }
.item-info { flex:2; }
.quantidades { text-align:right; flex:1; font-size:0.9em; color:#555; }
.status-select { flex:1; }
#upload-section { text-align:center; margin-top:20px; }
@media(max-width:600px){
  .item-row { flex-direction:column; align-items:flex-start; }
  .quantidades { text-align:left; width:100%; }
  .status-select { width:50%; margin-top:5px; }
}
</style>
</head>
<body>

<header>
  <img src="https://site.siteargus.com.br/sendThumb.asp?idcliente=543&path=parceiro&file=27_6_543_458_13510820_510120865837737_6061197160572500699_n.jpg&width=280" alt="Logo BF Box">
  <div class="hora" id="hora"></div>
</header>

<section>
  <div id="machines"></div>
</section>

<div id="upload-section">
  <input type="file" id="file">
  <button onclick="upload()">Carregar XLS</button>
</div>

<script>
const socket = io();
const machinesDiv = document.getElementById('machines');

function renderMachines(data){
  machinesDiv.innerHTML = '';
  const grouped = {};
  data.forEach((item, i)=>{
    const maquina = item.maquina;
    if(!grouped[maquina]) grouped[maquina] = [];
    grouped[maquina].push({...item, index:i});
  });

  for(const m in grouped){
    const card = document.createElement('div');
    card.className = 'machine-card';
    const title = document.createElement('h2');
    title.textContent = m;
    card.appendChild(title);

    grouped[m].forEach(item=>{
      const row = document.createElement('div');
      row.className = 'item-row';
      if(item.prioridade) row.classList.add('prioridade');

      const info = document.createElement('div');
      info.className = 'item-info';
      info.textContent = item.item;
      row.appendChild(info);

      const quant = document.createElement('div');
      quant.className = 'quantidades';
      quant.textContent = `V:${item.vendido} E:${item.estoque} P:${item.produzir}`;
      row.appendChild(quant);

      const select = document.createElement('select');
      select.className = 'status-select';
      ['','Produção','Produção Finalizada','Acabamento','Acabamento Finalizado'].forEach(s=>{
        const opt = document.createElement('option');
        opt.value = s;
        opt.textContent = s;
        if(s===item.status) opt.selected = true;
        select.appendChild(opt);
      });
      select.addEventListener('change', ()=>updateStatus(item.index, select.value));
      row.appendChild(select);

      card.appendChild(row);
    });

    machinesDiv.appendChild(card);
  }
}

// Atualiza o status via POST
function updateStatus(index, status){
  fetch('/update',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({index,status})
  });
}

// Upload XLS
async function upload(){
  const file = document.getElementById('file').files[0];
  if(!file){ alert('Selecione um arquivo'); return; }
  const form = new FormData();
  form.append('file', file);

  const res = await fetch('/upload',{method:'POST',body:form});
  const json = await res.json();
  if(json.ok) alert(`Arquivo carregado: ${json.total} itens`);
  else alert('Erro no upload');
}

// Recebe atualizações em tempo real
socket.on('update', data=>{
  renderMachines(data);
});

// Atualiza hora
function updateHora(){
  const h = new Date();
  document.getElementById('hora').textContent = h.toLocaleString();
}
setInterval(updateHora,1000);
updateHora();
</script>

</body>
</html>
