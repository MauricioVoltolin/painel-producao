<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Painel BF Box - Produção & Cargas</title>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
<style>
body { font-family:sans-serif; margin:0; padding:0; background:#f5f5f5; }
header { display:flex; justify-content:space-between; align-items:center; padding:10px; background:#fff; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
header img { height:50px; }
header .hora { font-weight:bold; }
#filtro-maquinas { text-align:center; margin:10px; }
#filtro-maquinas select { padding:5px 10px; font-size:1em; }
.tabs { display:flex; justify-content:center; margin:10px; }
.tab { margin:0 10px; padding:5px 10px; cursor:pointer; border-radius:5px; background:#ddd; }
.tab.active { background:#bbb; font-weight:bold; }

section { padding:10px; }
.machine-card, .carga-card { background:#fff; margin-bottom:10px; padding:10px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1); display:flex; flex-direction:column; }
.machine-card h2, .carga-card h2 { margin:0 0 10px 0; }
.item-row { display:flex; justify-content:space-between; padding:5px 0; border-bottom:1px solid #eee; align-items:center; }
.item-row.prioridade { background:#fff59d; } /* PRIORIDADE AMARELO */
.item-info { flex:2; }
.quantidades { text-align:right; flex:1; font-size:0.9em; color:#555; }
.status-select { flex:1; }
#upload-section { text-align:center; margin-top:20px; }
button.add-item { margin-top:5px; padding:3px 6px; font-size:0.9em; }

@media(max-width:600px){
  .item-row { flex-direction:column; align-items:flex-start; }
  .quantidades { text-align:left; width:100%; }
  .status-select { width:50%; margin-top:5px; }
}
</style>
</head>
<body>

<header>
  <img src="https://site.siteargus.com.br/sendThumb.asp?idcliente=543&path=parceiro&file=27_6_543_458_13510820_510120865837737_6061197160572500699_n.jpg&width=280" alt="Logo BF Box">
  <div class="hora" id="hora"></div>
</header>

<div id="filtro-maquinas">
  <label>Filtrar por máquina: </label>
  <select id="selectMaquina">
    <option value="">Todas</option>
  </select>
</div>

<div class="tabs">
  <div class="tab active" data-tab="producao">Produção</div>
  <div class="tab" data-tab="cargas">Cargas</div>
</div>

<section id="producao-tab">
  <div id="machines"></div>
</section>

<section id="cargas-tab" style="display:none;">
  <div id="cargas-container"></div>
  <button onclick="addCarga()" style="margin-top:10px;">Adicionar nova carga</button>
</section>

<div id="upload-section">
  <input type="file" id="file">
  <button onclick="upload()">Carregar XLS</button>
</div>

<script>
const socket = io();
const machinesDiv = document.getElementById('machines');
const selectMaquina = document.getElementById('selectMaquina');
let currentData = [];

function renderMachines(data){
  machinesDiv.innerHTML = '';
  const grouped = {};
  data.forEach((item, i)=>{
    const maquina = item.maquina;
    if(!grouped[maquina]) grouped[maquina] = [];
    grouped[maquina].push({...item, index:i});
  });

  // Atualiza filtro de máquinas
  selectMaquina.innerHTML = '<option value="">Todas</option>';
  Object.keys(grouped).forEach(m=>{
    selectMaquina.innerHTML += `<option value="${m}">${m}</option>`;
  });

  const filter = selectMaquina.value;
  for(const m in grouped){
    if(filter && m!==filter) continue;
    const card = document.createElement('div');
    card.className = 'machine-card';
    const title = document.createElement('h2');
    title.textContent = m;
    card.appendChild(title);

    grouped[m].forEach(item=>{
      const row = document.createElement('div');
      row.className = 'item-row';
      if(item.prioridade) row.classList.add('prioridade');

      const info = document.createElement('div');
      info.className = 'item-info';
      info.textContent = item.item;
      row.appendChild(info);

      const quant = document.createElement('div');
      quant.className = 'quantidades';
      quant.textContent = `V:${item.vendido} E:${item.estoque} P:${item.produzir}`;
      row.appendChild(quant);

      const select = document.createElement('select');
      select.className = 'status-select';
      ['','Produção','Produção Finalizada','Acabamento','Acabamento Finalizado'].forEach(s=>{
        const opt = document.createElement('option');
        opt.value = s;
        opt.textContent = s;
        if(s===item.status) opt.selected = true;
        select.appendChild(opt);
      });
      select.addEventListener('change', ()=>updateStatus(item.index, select.value));
      row.appendChild(select);

      card.appendChild(row);
    });

    machinesDiv.appendChild(card);
  }
}

// STATUS UPDATE
function updateStatus(index, status){
  fetch('/update',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({index,status})
  });
}

// UPLOAD XLS
async function upload(){
  const file = document.getElementById('file').files[0];
  if(!file){ alert('Selecione um arquivo'); return; }
  const form = new FormData();
  form.append('file', file);

  const res = await fetch('/upload',{method:'POST',body:form});
  const json = await res.json();
  if(json.ok) alert(`Arquivo carregado: ${json.total} itens`);
  else alert('Erro no upload');
}

// SOCKET.IO
socket.on('update', data=>{
  currentData = data;
  renderMachines(currentData);
});

// HORA
function updateHora(){
  const h = new Date();
  document.getElementById('hora').textContent = h.toLocaleString();
}
setInterval(updateHora,1000);
updateHora();

// ABAS
document.querySelectorAll('.tab').forEach(tab=>{
  tab.addEventListener('click', ()=>{
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById('producao-tab').style.display = tab.dataset.tab==='producao'?'block':'none';
    document.getElementById('cargas-tab').style.display = tab.dataset.tab==='cargas'?'block':'none';
  });
});

// ABAS DE CARGA
const cargasContainer = document.getElementById('cargas-container');

function createCargaCard(title){
  const card = document.createElement('div');
  card.className = 'carga-card';
  const h = document.createElement('h2');
  h.textContent = title;
  card.appendChild(h);

  const selectStatus = document.createElement('select');
  ['Pendente','Carregando','Pronto'].forEach(s=>{
    const opt = document.createElement('option');
    opt.value = s;
    opt.textContent = s;
    selectStatus.appendChild(opt);
  });
  card.appendChild(selectStatus);

  const itemsDiv = document.createElement('div');
  itemsDiv.className = 'items-div';
  card.appendChild(itemsDiv);

  const addBtn = document.createElement('button');
  addBtn.className = 'add-item';
  addBtn.textContent = 'Adicionar item';
  addBtn.addEventListener('click', ()=>{
    const nome = prompt('Nome do item:');
    if(!nome) return;
    const row = document.createElement('div');
    row.className = 'item-row';
    const info = document.createElement('div');
    info.className = 'item-info';
    info.textContent = nome;
    row.appendChild(info);

    const selectItemStatus = document.createElement('select');
    ['Aguardando','Faturado'].forEach(s=>{
      const opt = document.createElement('option');
      opt.value = s;
      opt.textContent = s;
      selectItemStatus.appendChild(opt);
    });
    row.appendChild(selectItemStatus);
    itemsDiv.appendChild(row);
  });
  card.appendChild(addBtn);

  cargasContainer.appendChild(card);
}

// CARGA 01 fixa
createCargaCard('CARGA 01');

function addCarga(){
  const title = prompt('Título da nova carga:');
  if(!title) return;
  createCargaCard(title);
}
</script>

</body>
</html>
